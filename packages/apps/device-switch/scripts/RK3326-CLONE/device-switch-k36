#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2024-present JELOS (https://github.com/JustEnoughLinuxOS)

. /etc/profile

mount -o remount,rw /flash

# Comment out all DTB lines first
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-batlexp-g350\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-batlexp-g350.dtb|' /flash/boot.ini
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-clone.*\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-clone.dtb|' /flash/boot.ini
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-kinhank-k36\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-kinhank-k36.dtb|' /flash/boot.ini
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-xifan-mymini\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-xifan-mymini.dtb|' /flash/boot.ini
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-xifan-xf35-40h\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-xifan-xf35-40h.dtb|' /flash/boot.ini
sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-gameconsole-r36-ultra\.dtb|#  load mmc 1:1 ${dtb_loadaddr} rk3326-gameconsole-r36-ultra.dtb|' /flash/boot.ini

case $1 in
  CLONE)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-clone.*\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-clone.dtb|' /flash/boot.ini
    ;;
  CLONE_V2)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-clone.*\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-clone-v2.dtb|' /flash/boot.ini
    ;;
  R36_ULTRA)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-gameconsole-r36-ultra\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-gameconsole-r36-ultra.dtb|' /flash/boot.ini
    ;;
  KINHANK_K36)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-kinhank-k36\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-kinhank-k36.dtb|' /flash/boot.ini
    ;;
  XIFAN_MYMINI)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-xifan-mymini\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-xifan-mymini.dtb|' /flash/boot.ini
    ;;
  XIFAN_XF35_40H)
    sed -i 's|^[# ]*load mmc 1:1 \${dtb_loadaddr} rk3326-xifan-xf35-40h\.dtb|  load mmc 1:1 ${dtb_loadaddr} rk3326-xifan-xf35-40h.dtb|' /flash/boot.ini
    ;;
esac

cat <<EOF >/flash/device.name
$1
EOF

sync
reboot